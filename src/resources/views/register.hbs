<!-- Form Html -->
<div class="pages">
    {{>header}}
    <div class="main-page">
        {{>mainproperties}}
        <div class="main-part">
            <div class="main__register">
                <form action="" method="POST" class="form" id="register_form">
                    <h3 class="form__heading">ĐĂNG KÝ KHÁCH HÀNG</h3>
                    <p class="form__subheading">People will stare, make it worth their while.</p>
                    <div class="spacer"></div>
                    <div class="form__group">
                        <label for="fullname" class="form__group__label">Tên đầy đủ</label>
                        <input id="fullname" name="fullname" rules="required" type="text" class="form__group__input"
                            placeholder="VD: Duy Phong">
                        <span class="form__group__message"></span>
                    </div>

                    <div class="form__group">
                        <label for="email" class="form__group__label">Email</label>
                        <input id="email" name="email" rules="required|email" type="email" class="form__group__input"
                            placeholder="VD: phchmessibar326@gmail.com">
                        <span class="form__group__message"></span>
                    </div>

                    <div class="form__group">
                        <label for="pass" class="form__group__label">Nhập mật khẩu</label>
                        <input id="pass" name="pass" rules="required|strongPass" type="password" class="form__group__input"
                            placeholder="Nhập mật khẩu">
                        <span class="message_default">Mật khẩu phải có chứa nhất bảy kí tự,một chữ số và một ký tự đặc biệt!</span>
                        <span class="form__group__message"></span>
                    </div>

                    <div class="form__group">
                        <label for="repass" class="form__group__label">Nhập lại mật khẩu</label>
                        <input id="repass" name="repass" rules="required|repass" type="password" class="form__group__input"
                            placeholder="Nhập lại mật khẩu">
                        <span class="form__group__message"></span>
                    </div>

                    <button class="form__btn">Đăng ký</button>
                </form>
            </div>
        </div>
    </div>
    {{>footer}}
</div>
<script src="./Validator_solution_2.js"></script>
<!-- Validator -->
<script>
    Validator('#register_form', {
        inforAfterSubmit: function (data) {
            console.log(data);
        }
    });
    function Validator(selector, options) {
        if (!options) {
            options = {};
        }
        // lay the cha
        function getParent(element, parent_name) {
            while (element.parentElement) {
                if (element.parentElement.matches(parent_name)) {
                    return element.parentElement;
                }
                element = element.parentElement;
            }
        };

        var formRules = {};
        var validateRules = {
            required: function (value) {
                return value ? undefined : 'Vui lòng nhập thông tin';
            },
            email: function (value) {
                // ? phuong thuc test() dung de kiem tra xem trong mot chuoi co chua chuoi con khop voi mo hinh chuoi hay khong
                // todo: regex.test(_string)
                var regex = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return regex.test(value) ? undefined : 'Thông tin email của bạn không đúng';
            },
            strongPass: function (value) {
                var passStrong = /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{7,99}$/;
                return passStrong.test(value) ? undefined : 'Mật khẩu của bạn không đủ mạnh,vui lòng nhập lại mật khẩu';
            },
            repass: function (value) {
                var pass_value = document.querySelector('#register_form #pass');
                return value === pass_value.value ? undefined : 'Mật khẩu bạn nhập không khớp, vui lòng nhập lại';
            }
        }


        var formElement = document.querySelector(selector);
        if (formElement) {
            var inputElements = formElement.querySelectorAll('[name][rules]');
            for (var input of inputElements) {
                // su dung getAttribute voi cac attribute tu dinh nghia
                var rules = input.getAttribute('rules').split('|');
                for (var rule of rules) {
                    if (Array.isArray(formRules[input.name])) {
                        formRules[input.name].push(validateRules[rule]);
                    } else {
                        formRules[input.name] = [validateRules[rule]];
                    }
                }
                input.onblur = validate;
                input.oninput = function (event) {
                    var ParentOfSpan = getParent(event.target, '.form__group');
                    var tagSpan = ParentOfSpan.querySelector('.form__group__message');
                    tagSpan.innerText = ``;
                    ParentOfSpan.classList.remove('invalid');
                };
            }
            // ham thuc hien validate
            function validate(event) {
                var input_rules = formRules[event.target.name];
                var messageError;
                for (var rule of input_rules) {
                    messageError = rule(event.target.value);
                    if (messageError) break;
                }
                if (messageError) {
                    var ParentOfSpan = getParent(event.target, '.form__group');
                    var tagSpan = ParentOfSpan.querySelector('.form__group__message');
                    if (tagSpan) {
                        tagSpan.innerText = messageError;
                        ParentOfSpan.classList.add('invalid');
                    } else {
                        tagSpan.innerText = ``;
                        ParentOfSpan.classList.remove('invalid');
                    }
                }
                return !messageError;
            };
        };
        // xu li validate khi submit form
        formElement.onsubmit = function (e) {
            e.preventDefault();
            var inputElements = formElement.querySelectorAll('[name][rules]');
            var isNotValid = true; // bien kiem tra xem co input nao bi validate khong
            for (var input of inputElements) {
                if (!validate({ target: input })) {
                    isNotValid = false;
                }
                validate({ target: input });
            }
            console.log(isNotValid);
            if (isNotValid) {
                if (typeof options.inforAfterSubmit === "function") {
                    var enableInputs = formElement.querySelectorAll('[name]');
                    var formValues = Array.from(enableInputs).reduce(function (values, currentElement) {
                        values[currentElement.name] = currentElement.value;
                        return values;
                    }, {});
                    options.inforAfterSubmit(formValues);
                }
            }
        };
    };
</script>